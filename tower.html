<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¼ìŸì˜ íƒ‘ - ë‚´íƒ“ë„¤íƒ“</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 0; background-color: #1a1a1a; font-family: 'Pretendard', sans-serif; color: #ffffff; }
        .mobile-container {
            width: 100%; max-width: 430px; min-height: 100vh; margin: 0 auto;
            display: flex; flex-direction: column; padding: 40px 20px; box-sizing: border-box;
            background: linear-gradient(180deg, #1a1a1a 0%, #2d3436 100%);
        }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back-btn { font-size: 28px; color: #fff; text-decoration: none; cursor: pointer; }
        
        .tower-status { text-align: center; margin-bottom: 10px; }
        .floor-num { font-size: 32px; font-weight: 900; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .survival-badge { background: #00b894; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; display: inline-block; }
        .eliminated-badge { background: #d63031 !important; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; display: inline-block; }

        .debate-card {
            background: rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px 20px;
            text-align: center; border: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px;
            min-height: 250px; display: flex; flex-direction: column; justify-content: center;
        }
        .timer { font-size: 16px; color: #ffd700; font-weight: bold; margin-bottom: 10px; }
        .question { font-size: 16px; font-weight: 500; line-height: 1.7; word-break: keep-all; text-align: left; white-space: pre-wrap; }

        .result-box { margin-top: 15px; display: none; }
        .gauge-bar {
            height: 25px; width: 100%; background: #444; border-radius: 12px;
            overflow: hidden; display: flex; position: relative; border: 1px solid rgba(255,255,255,0.1);
        }
        .gauge-my { height: 100%; background: #0984e3; transition: width 0.5s ease-in-out; }
        .gauge-your { height: 100%; background: #e84393; transition: width 0.5s ease-in-out; }
        .gauge-text {
            position: absolute; width: 100%; display: flex; justify-content: space-between;
            padding: 0 10px; box-sizing: border-box; line-height: 25px; font-size: 12px; font-weight: bold;
        }

        .vote-group { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-bottom: 20px; }
        .vote-btn {
            padding: 20px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold;
            cursor: pointer; transition: 0.3s; color: white;
        }
        .btn-my { background: #0984e3; border: 2px solid transparent; }
        .btn-your { background: #e84393; border: 2px solid transparent; }
        .vote-btn.selected { border-color: #ffffff; box-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .vote-btn:disabled { background: #444; cursor: not-allowed; opacity: 0.5; }
        
        .revive-btn {
            background: #ffd700; color: #000; padding: 15px; border-radius: 15px;
            font-weight: bold; border: none; margin-top: 20px; cursor: pointer; width: 100%;
        }

        /* ğŸ’¬ ëŒ“ê¸€ ì˜ì—­ ìŠ¤íƒ€ì¼ ì¶”ê°€ [cite: 2026-01-29] */
        .comment-section { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        .comment-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .comment-input { 
            flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px; padding: 10px; color: white; font-size: 14px;
        }
        .comment-submit { background: #ffd700; border: none; border-radius: 10px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        
        .best-label { color: #ffd700; font-size: 12px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .comment-list { display: flex; flex-direction: column; gap: 12px; }
        .comment-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .comment-header { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-bottom: 6px; }
        .comment-user { color: #aaa; font-weight: bold; }
        .comment-content { font-size: 14px; line-height: 1.5; color: #eee; margin-bottom: 8px; }
        .comment-footer { display: flex; justify-content: flex-end; }
        .like-btn { 
            background: none; border: 1px solid rgba(255,215,0,0.3); color: #ffd700; 
            border-radius: 15px; padding: 2px 10px; font-size: 11px; cursor: pointer;
        }

        .reward-info {
            margin-top: 40px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 15px;
            font-size: 13px; text-align: center;
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="header">
            <div class="back-btn" onclick="location.href='main.html'">&lt;</div>
            <div id="userCoinDisplay" style="color: #ffd700; font-weight: bold;">ğŸŸ¡ 0</div>
        </div>

        <div class="tower-status">
            <div id="currentFloor" class="floor-num">1ì¸µ</div>
            <span id="statusBadge" class="survival-badge">ìƒì¡´ ì¤‘</span>
        </div>

        <div class="debate-card">
            <div class="timer" id="roundTimer">ë‚¨ì€ ì‹œê°„ ê³„ì‚° ì¤‘...</div>
            <div class="question" id="debateQuestion">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            
            <div id="resultBox" class="result-box">
                <div class="gauge-bar">
                    <div id="barMy" class="gauge-my"></div>
                    <div id="barYour" class="gauge-your"></div>
                    <div class="gauge-text">
                        <span id="textMy">ë‚´ íƒ“ 0%</span>
                        <span id="textYour">ë„¤ íƒ“ 0%</span>
                    </div>
                </div>
                <div id="winTag" style="color:#ffd700; font-size:12px; margin-top:8px; font-weight:bold;">íŒê²° ì™„ë£Œ</div>
            </div>
        </div>

        <div class="vote-group" id="voteGroup">
            <button id="btnMy" class="vote-btn btn-my" onclick="castVote('my')">ë‚´ íƒ“ì´ë‹¤</button>
            <button id="btnYour" class="vote-btn btn-your" onclick="castVote('your')">ë„¤ íƒ“ì´ë‹¤</button>
        </div>

        <button id="reviveBtn" class="revive-btn" style="display: none;" onclick="revive()">
            ğŸŸ¡ 100 ì½”ì¸ìœ¼ë¡œ ë¶€í™œí•˜ê¸°
        </button>

        <div class="comment-section">
            <div class="comment-input-group">
                <input type="text" id="commentInput" class="comment-input" placeholder="ë…¼ë¦¬ì ì¸ ëŒ“ê¸€ë¡œ ì„¤ë“í•´ë³´ì„¸ìš”...">
                <button class="comment-submit" onclick="addComment()">ë“±ë¡</button>
            </div>

            <div class="best-label">ğŸ‘‘ ë² ìŠ¤íŠ¸ íŒê²°ë¬¸</div>
            <div id="bestCommentList" class="comment-list" style="margin-bottom: 25px;">
                </div>

            <div class="best-label" style="color: #888;">ìµœì‹  ëŒ“ê¸€</div>
            <div id="commentList" class="comment-list">
                </div>
        </div>

        <div class="reward-info">
            í˜„ì¬ ì¸µ í†µê³¼ ë³´ìƒ: <span id="rewardCoin" style="color: #ffd700;">10ê°œ</span><br>
            <span style="font-size: 11px; color: #888;">55ë¶„ê¹Œì§€ íˆ¬í‘œí•´ì•¼ ë‹¤ìŒ ì¸µìœ¼ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</span>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            projectId: "sxsx-75c73",
            storageBucket: "sxsx-75c73.appspot.com",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const rewards = [10, 30, 50, 80, 120, 150, 200, 250, 300, 500];
        
        let gameState = JSON.parse(localStorage.getItem('towerState')) || {
            currentFloor: 1, isEliminated: false, lastVotedRound: -1, selectedSide: null, lastCheckedHour: -1
        };

        function fetchQuestion() {
            db.collection("tower_questions").doc("today").onSnapshot((doc) => {
                if (doc.exists) {
                    document.getElementById('debateQuestion').innerText = doc.data().content;
                }
            });
        }

        // ğŸ’¬ ì‹¤ì‹œê°„ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° [cite: 2026-01-29]
        function fetchComments() {
            db.collection("tower_comments")
              .orderBy("createdAt", "desc")
              .onSnapshot((snapshot) => {
                const comments = [];
                snapshot.forEach(doc => comments.push({id: doc.id, ...doc.data()}));
                
                // ë² ìŠ¤íŠ¸ ëŒ“ê¸€ ì •ë ¬ (ì¢‹ì•„ìš” 1ê°œ ì´ìƒ ì¤‘ ê°€ì¥ ë†’ì€ ê²ƒ í•˜ë‚˜)
                const best = [...comments].sort((a,b) => b.likes - a.likes).filter(c => c.likes > 0)[0];
                
                renderComments(comments, best);
            });
        }

        function renderComments(comments, best) {
            const list = document.getElementById('commentList');
            const bestList = document.getElementById('bestCommentList');
            
            list.innerHTML = "";
            bestList.innerHTML = "";

            if(best) {
                bestList.innerHTML = createCommentHTML(best, true);
            } else {
                bestList.innerHTML = "<div style='font-size:12px; color:#555;'>ì•„ì§ ë² ìŠ¤íŠ¸ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            }

            comments.forEach(c => {
                list.innerHTML += createCommentHTML(c, false);
            });
        }

        function createCommentHTML(c, isBest) {
            const date = c.createdAt ? new Date(c.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "ë°©ê¸ˆ ì „";
            return `
                <div class="comment-card" style="${isBest ? 'border-color: #ffd700;' : ''}">
                    <div class="comment-header">
                        <span class="comment-user">${c.userName}</span>
                        <span>${date}</span>
                    </div>
                    <div class="comment-content">${c.text}</div>
                    <div class="comment-footer">
                        <button class="like-btn" onclick="likeComment('${c.id}')">ğŸ‘ ${c.likes}</button>
                    </div>
                </div>
            `;
        }

        function addComment() {
            const input = document.getElementById('commentInput');
            const userData = JSON.parse(localStorage.getItem('userData')) || {nickname: "ìµëª…ì˜ ë“±ë°˜ì"};
            if(!input.value.trim()) return;

            db.collection("tower_comments").add({
                userName: userData.nickname,
                text: input.value,
                likes: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = "";
        }

        function likeComment(id) {
            db.collection("tower_comments").doc(id).update({
                likes: firebase.firestore.FieldValue.increment(1)
            });
        }

        function updateGame() {
            const now = new Date();
            const hour = now.getHours();
            const min = now.getMinutes();
            const sec = now.getSeconds();
            const isActiveTime = hour >= 9 || hour === 0;

            if (!isActiveTime) {
                document.getElementById('debateQuestion').innerText = "ë…¼ìŸì˜ íƒ‘ì€ ì˜¤ì „ 9ì‹œì— ì˜¤í”ˆë©ë‹ˆë‹¤.";
                document.getElementById('roundTimer').innerText = "Closed";
                disableAllButtons();
                return;
            }

            if (gameState.lastCheckedHour !== hour) {
                processRoundTransition(hour);
                gameState.lastCheckedHour = hour;
                saveState();
            }

            const isVotePhase = min < 55;
            document.getElementById('currentFloor').innerText = `${gameState.currentFloor}ì¸µ`;
            document.getElementById('rewardCoin').innerText = `${rewards[gameState.currentFloor-1]}ê°œ`;

            if (isVotePhase) {
                document.getElementById('roundTimer').innerText = `íˆ¬í‘œ ì¢…ë£Œê¹Œì§€ ${54 - min}ë¶„ ${59 - sec}ì´ˆ`;
                document.getElementById('resultBox').style.display = 'none';
                refreshButtons(true, hour);
            } else {
                document.getElementById('roundTimer').innerText = `ê²°ê³¼ í™•ì¸ ì¤‘...`;
                showGaugeResult();
                refreshButtons(false, hour);
            }
            refreshBadge();
            updateCoinDisplay();
        }

        function showGaugeResult() {
            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('barMy').style.width = '48%';
            document.getElementById('barYour').style.width = '52%';
            document.getElementById('textMy').innerText = `ë‚´ íƒ“ 48%`;
            document.getElementById('textYour').innerText = `ë„¤ íƒ“ 52%`;
        }

        function processRoundTransition(currentHour) {
            if (!gameState.isEliminated && currentHour > 9) {
                if (gameState.lastVotedRound < (currentHour - 1)) {
                    gameState.isEliminated = true;
                } else {
                    addCoin(rewards[gameState.currentFloor - 1]);
                    gameState.currentFloor = (gameState.currentFloor >= 10) ? 1 : gameState.currentFloor + 1;
                }
                gameState.selectedSide = null; 
            }
        }

        function castVote(side) {
            if (gameState.isEliminated || new Date().getMinutes() >= 55) return;
            gameState.lastVotedRound = new Date().getHours();
            gameState.selectedSide = side;
            saveState();
            alert("íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            refreshButtons(true, gameState.lastVotedRound);
        }

        function refreshButtons(isVotePhase, currentHour) {
            const btnMy = document.getElementById('btnMy');
            const btnYour = document.getElementById('btnYour');
            const alreadyVoted = gameState.lastVotedRound === currentHour;
            btnMy.disabled = btnYour.disabled = gameState.isEliminated || !isVotePhase || alreadyVoted;
            btnMy.classList.toggle('selected', gameState.selectedSide === 'my');
            btnYour.classList.toggle('selected', gameState.selectedSide === 'your');
        }

        function refreshBadge() {
            const badge = document.getElementById('statusBadge');
            const reviveBtn = document.getElementById('reviveBtn');
            if (gameState.isEliminated) {
                badge.innerText = "íƒˆë½ (ê´€ì „ ì¤‘)";
                badge.className = "eliminated-badge";
                reviveBtn.style.display = "block";
            } else {
                badge.innerText = "ìƒì¡´ ì¤‘";
                badge.className = "survival-badge";
                reviveBtn.style.display = "none";
            }
        }

        function revive() {
            let userData = JSON.parse(localStorage.getItem('userData')) || {coin: 0};
            if (userData.coin < 100) return alert("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            userData.coin -= 100;
            gameState.isEliminated = false;
            gameState.lastVotedRound = -1; 
            localStorage.setItem('userData', JSON.stringify(userData));
            saveState();
            location.reload();
        }

        function addCoin(amount) {
            let userData = JSON.parse(localStorage.getItem('userData')) || {coin: 0};
            userData.coin = (userData.coin || 0) + amount;
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        function updateCoinDisplay() {
            const userData = JSON.parse(localStorage.getItem('userData')) || {coin: 0};
            document.getElementById('userCoinDisplay').innerText = `ğŸŸ¡ ${userData.coin.toLocaleString()}`;
        }

        function disableAllButtons() {
            document.getElementById('btnMy').disabled = true;
            document.getElementById('btnYour').disabled = true;
        }

        function saveState() { localStorage.setItem('towerState', JSON.stringify(gameState)); }

        fetchQuestion();
        fetchComments(); // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
        setInterval(updateGame, 1000);
        updateGame();
    </script>
</body>
</html>