<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì¸ - ë‚´íƒ“ë„¤íƒ“</title>
    <style>
        body { margin: 0; background-color: #f5f5f5; font-family: 'Pretendard', sans-serif; color: #333; }
        
        .mobile-container {
            width: 100%; max-width: 430px; min-height: 100vh; margin: 0 auto;
            background-color: #ffffff; position: relative;
            display: flex; flex-direction: column; align-items: center; padding-top: 60px; box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* ğŸ”” ì•Œë¦¼ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .notification-header {
            position: absolute; top: 20px; right: 20px; z-index: 100;
        }
        .noti-btn {
            background: none; border: none; font-size: 24px; cursor: pointer; position: relative;
        }
        .noti-badge {
            position: absolute; top: -2px; right: -2px; background: red; color: white;
            font-size: 10px; width: 16px; height: 16px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            display: none; /* ì´ˆê¸°ê°’ ìˆ¨ê¹€ */
        }

        /* ğŸ“‚ ì•Œë¦¼ ì°½ ìŠ¤íƒ€ì¼ */
        .noti-dropdown {
            display: none; position: absolute; top: 55px; right: 20px; width: 280px;
            background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border: 1px solid #eee; overflow-y: auto; max-height: 400px; z-index: 101;
        }
        .noti-item {
            padding: 15px; border-bottom: 1px solid #f9f9f9; font-size: 13px; line-height: 1.4;
        }
        .noti-item:last-child { border-bottom: none; }
        .noti-item .time { color: #999; font-size: 11px; margin-top: 5px; }
        .noti-title { font-weight: bold; margin-bottom: 3px; display: block; }

        /* ê¸°ì¡´ ì‹¤ì‹œê°„ ì ‘ì†ì ë° ìƒíƒœ ë°” */
        .live-status {
            background: rgba(0, 200, 0, 0.1); border: 1px solid #00aa00; color: #00aa00;
            padding: 6px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; margin-bottom: 10px;
        }
        .user-status-bar {
            background: #f9f9f9; border: 1px solid rgba(255, 215, 0, 0.5);
            padding: 10px 20px; border-radius: 12px; display: flex; gap: 15px;
            font-size: 13px; margin-bottom: 30px; align-items: center; color: #333;
        }
        .rank-text { color: #9d4edd; font-weight: bold; }
        .coin-text { color: #b8860b; font-weight: bold; }

        .logo { font-size: 40px; font-weight: 900; margin-bottom: 40px; text-align: center; line-height: 1.2; color: #333; }
        .menu-group { width: 85%; display: flex; flex-direction: column; gap: 15px; }
        .menu-btn {
            background: #ffffff; border: 1px solid #ddd; padding: 20px; border-radius: 15px; color: #333;
            text-decoration: none; font-size: 18px; font-weight: bold; text-align: center; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="notification-header">
            <button class="noti-btn" onclick="toggleNoti(event)">
                ğŸ”” <span class="noti-badge" id="notiCount">0</span>
            </button>
            <div class="noti-dropdown" id="notiDropdown">
                </div>
        </div>

        <div class="live-status" id="liveUserBadge">â— ì‹¤ì‹œê°„ ì ‘ì† ë°°ì‹¬ì›: 120ëª…</div>

        <div class="user-status-bar">
            <div class="status-item"><span style="color: #666;">ë“±ê¸‰:</span> <span id="mainRank" class="rank-text">ë¡œë”© ì¤‘...</span></div>
            <div style="width: 1px; height: 12px; background: #ddd;"></div>
            <div class="status-item"><span style="color: #666;">ë³´ìœ :</span> <span class="coin-text">ğŸŸ¡ <span id="mainCoin">0</span></span></div>
        </div>

        <div class="logo">âš–ï¸<br>ë‚´íƒ“ë„¤íƒ“</div>

        <div class="menu-group">
            <a href="write.html" class="menu-btn">âš–ï¸ ì‚¬ê±´ ì ‘ìˆ˜í•˜ê¸°</a>
            <a href="list.html" class="menu-btn">ğŸ“œ ì‚¬ê±´ ê¸°ë¡ ì—´ëŒì‹¤</a>
            <a href="retry.html" class="menu-btn">ğŸ”¨ ì¬ì‹¬ íŒê²°ë‹¨</a>
            <a href="mypage.html" class="menu-btn">ğŸ‘¤ ë§ˆì´í˜ì´ì§€</a>
        </div>
    </div>

    <script>
        // 1. ì•Œë¦¼ í† ê¸€ ê¸°ëŠ¥
        function toggleNoti(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('notiDropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // ì•Œë¦¼ì°½ ì—´ ë•Œ í™•ì¸í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•˜ê³  ë°°ì§€ ìˆ¨ê¹€
                document.getElementById('notiCount').style.display = 'none';
            }
        }

        window.onclick = function(event) {
            if (!event.target.closest('.notification-header')) {
                document.getElementById('notiDropdown').style.display = 'none';
            }
        }

        // 2. ì‹¤ì‹œê°„ ì•Œë¦¼ ìƒì„± ë° ì²´í¬ ë¡œì§ (ì¶”ê°€ë¨)
        function checkNewNotifications() {
            const cases = JSON.parse(localStorage.getItem('myCases') || '[]');
            let notifications = JSON.parse(localStorage.getItem('userNoti') || []);
            
            let hasNew = false;

            cases.forEach(item => {
                // íŒê²°ì´ ì¢…ë£Œ(isClosed)ë˜ì—ˆëŠ”ë° ì•„ì§ ì•Œë¦¼(notified)ì„ ì•ˆ ì¤€ ê²½ìš°
                if (item.isClosed && !item.notified) {
                    let msg = "";
                    // ë‚´ê°€ ì“´ ê¸€ì¸ ê²½ìš°
                    if (item.isMine) {
                        msg = `âš–ï¸ íŒê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: '${item.title}'ì˜ ìµœì¢… ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
                    } 
                    // ë‚´ê°€ íˆ¬í‘œí•œ ê¸€ì¸ ê²½ìš°
                    else if (item.voted) {
                        msg = `ğŸ—³ï¸ íˆ¬í‘œ ê²°ê³¼ ì•Œë¦¼: ì°¸ì—¬í•˜ì‹  '${item.title}' íŒê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    }

                    if (msg) {
                        notifications.unshift({ title: "íŒê²° ì¢…ë£Œ", content: msg, time: "ë°©ê¸ˆ ì „" });
                        item.notified = true; // ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ í”Œë˜ê·¸
                        hasNew = true;
                    }
                }
            });

            if (hasNew) {
                localStorage.setItem('userNoti', JSON.stringify(notifications));
                localStorage.setItem('myCases', JSON.stringify(cases));
            }
            renderNotiList(notifications);
        }

        function renderNotiList(notifications) {
            const listContainer = document.getElementById('notiDropdown');
            const badge = document.getElementById('notiCount');

            if (notifications.length === 0) {
                listContainer.innerHTML = '<div class="noti-item" style="text-align:center; color:#999;">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                badge.style.display = 'none';
            } else {
                badge.innerText = notifications.length;
                badge.style.display = 'flex';
                listContainer.innerHTML = notifications.map(n => `
                    <div class="noti-item">
                        <span class="noti-title">${n.title}</span>
                        ${n.content}
                        <div class="time">${n.time}</div>
                    </div>
                `).join('');
            }
        }

        // 3. ê¸°ì¡´ ë°ì´í„° ë¡œë“œ ë¡œì§
        function updateLiveUsers() {
            const count = Math.floor(Math.random() * (350 - 150 + 1)) + 150;
            document.getElementById('liveUserBadge').innerText = `â— ì‹¤ì‹œê°„ ì ‘ì† ë°°ì‹¬ì›: ${count}ëª…`;
        }
        setInterval(updateLiveUsers, 4000);
        updateLiveUsers();

        function loadMainUserInfo() {
            const userData = JSON.parse(localStorage.getItem('userData')) || { coin: 1000 };
            document.getElementById('mainCoin').innerText = userData.coin.toLocaleString();
            
            const lp = parseInt(localStorage.getItem('userPoints') || '0');
            const badgeEl = document.getElementById('mainRank');
            
            let rankName = "ì‹ ì… ë°°ì‹¬ì›";
            if (lp >= 50000) rankName = "ëª…ì˜ˆ ëŒ€ë²•ê´€";
            else if (lp >= 15000) rankName = "ë¶€ì¥íŒì‚¬";
            else if (lp >= 5000) rankName = "í‰íŒì‚¬";
            else if (lp >= 1000) rankName = "ì‚¬ë²•ì—°ìˆ˜ìƒ";
            badgeEl.innerText = rankName;

            // ìœ ì € ì •ë³´ ë¡œë“œ í›„ ì•Œë¦¼ ì²´í¬ ì‹¤í–‰
            checkNewNotifications();
        }

        window.onload = loadMainUserInfo;
    </script>
</body>
</html>